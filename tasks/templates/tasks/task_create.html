{% extends 'tasks/base.html' %}
{% load static %}

{% block title %}{{ title }} - 任务管理工具{% endblock %}

{% block content %}
<div class="view-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>{{ title }}</h3>
        <a class="btn btn-outline-secondary" href="{% if task %}{% url 'tasks:task_detail' task.id %}{% else %}{% url 'tasks:task_list' %}{% endif %}">
            <i class="bi bi-arrow-left"></i> 返回
        </a>
    </div>
    
    <div class="card">
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                
                {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {% for error in form.non_field_errors %}
                        {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
                
                <div class="mb-3">
                    <label for="{{ form.task_title.id_for_label }}" class="form-label">任务标题 *</label>
                    {{ form.task_title }}
                    {% if form.task_title.errors %}
                    <div class="text-danger">
                        {% for error in form.task_title.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                
                <div class="mb-3">
                    <label for="{{ form.task_description.id_for_label }}" class="form-label">任务描述</label>
                    {{ form.task_description }}
                    {% if form.task_description.errors %}
                    <div class="text-danger">
                        {% for error in form.task_description.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ form.task_belongsto_project_id.id_for_label }}" class="form-label">项目 *</label>
                            {{ form.task_belongsto_project_id }}
                            {% if form.task_belongsto_project_id.errors %}
                            <div class="text-danger">
                                {% for error in form.task_belongsto_project_id.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ form.task_belongsto_model_id.id_for_label }}" class="form-label">机型 *</label>
                            {{ form.task_belongsto_model_id }}
                            {% if form.task_belongsto_model_id.errors %}
                            <div class="text-danger">
                                {% for error in form.task_belongsto_model_id.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ form.task_type.id_for_label }}" class="form-label">任务类型 *</label>
                            {{ form.task_type }}
                            {% if form.task_type.errors %}
                            <div class="text-danger">
                                {% for error in form.task_type.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ form.task_priority.id_for_label }}" class="form-label">优先级 *</label>
                            {{ form.task_priority }}
                            {% if form.task_priority.errors %}
                            <div class="text-danger">
                                {% for error in form.task_priority.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ form.task_deadline.id_for_label }}" class="form-label">截止日期</label>
                            {{ form.task_deadline }}
                            {% if form.task_deadline.errors %}
                            <div class="text-danger">
                                {% for error in form.task_deadline.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ form.task_status.id_for_label }}" class="form-label">状态 *</label>
                            {{ form.task_status }}
                            {% if form.task_status.errors %}
                            <div class="text-danger">
                                {% for error in form.task_status.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="{{ form.task_assigned_to_user_id.id_for_label }}" class="form-label">负责人</label>
                    {{ form.task_assigned_to_user_id }}
                    {% if form.task_assigned_to_user_id.errors %}
                    <div class="text-danger">
                        {% for error in form.task_assigned_to_user_id.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                
                <div class="mb-3" id="sourceTaskField" style="display: none;">
                    <label for="{{ form.task_source_task_id.id_for_label }}" class="form-label">源任务</label>
                    {{ form.task_source_task_id }}
                    {% if form.task_source_task_id.errors %}
                    <div class="text-danger">
                        {% for error in form.task_source_task_id.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                
                <div class="d-flex justify-content-end">
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
// 动态加载机型选项
function loadModels(projectId) {
    console.log('Loading models for project:', projectId);
    const modelSelect = document.getElementById('id_task_belongsto_model_id');

    if (projectId) {
        // 清空现有选项
        modelSelect.innerHTML = '';

        // 添加加载中的选项
        const loadingOption = document.createElement('option');
        loadingOption.value = '';
        loadingOption.textContent = '加载中...';
        modelSelect.appendChild(loadingOption);

        // 发送AJAX请求获取机型
        fetch(`/project/${projectId}/models/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络响应不正常');
                }
                return response.json();
            })
            .then(data => {
                console.log('Received models:', data);

                // 清空选项
                modelSelect.innerHTML = '';

                // 添加默认选项
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '选择机型';
                modelSelect.appendChild(defaultOption);

                // 添加机型选项
                if (data && data.length > 0) {
                    data.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.id;
                        option.textContent = model.name;
                        modelSelect.appendChild(option);
                    });
                } else {
                    const noModelsOption = document.createElement('option');
                    noModelsOption.value = '';
                    noModelsOption.textContent = '该项目暂无机型';
                    modelSelect.appendChild(noModelsOption);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                modelSelect.innerHTML = '';

                const errorOption = document.createElement('option');
                errorOption.value = '';
                errorOption.textContent = '加载失败';
                modelSelect.appendChild(errorOption);
            });
    } else {
        // 清空选项
        modelSelect.innerHTML = '';

        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = '请先选择项目';
        modelSelect.appendChild(defaultOption);
    }
}

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    const projectSelect = document.getElementById('id_task_belongsto_project_id');
    const modelSelect = document.getElementById('id_task_belongsto_model_id');

    console.log('Page loaded, project select:', projectSelect);
    console.log('Page loaded, model select:', modelSelect);

    // 如果项目已选择，加载对应的机型
    if (projectSelect && projectSelect.value) {
        console.log('Initial project selected:', projectSelect.value);
        loadModels(projectSelect.value);
    }

    // 监听项目选择变化
    if (projectSelect) {
        projectSelect.addEventListener('change', function() {
            console.log('Project changed:', this.value);
            loadModels(this.value);
        });
    }

    // 根据任务类型显示/隐藏源任务字段
    const taskTypeSelect = document.getElementById('{{ form.task_type.id_for_label }}');
    const sourceTaskField = document.getElementById('sourceTaskField');

    function toggleSourceTaskField() {
        // 确保元素存在再操作
        if (!taskTypeSelect || !sourceTaskField) return;

        if (taskTypeSelect.value === 'feedback') {
            sourceTaskField.style.display = 'block';
        } else {
            sourceTaskField.style.display = 'none';
        }
    }

    // 确保 DOM 加载完成后执行初始化
    document.addEventListener('DOMContentLoaded', function() {
        toggleSourceTaskField(); // 移到 DOM 加载完成后执行
    });

    // 初始检查
    toggleSourceTaskField();

    // 监听变化
    if (taskTypeSelect) {
        taskTypeSelect.addEventListener('change', toggleSourceTaskField);
    }

    // 设置默认日期为明天
    const dueDateInput = document.getElementById('{{ form.task_deadline.id_for_label }}');
    if (dueDateInput && !dueDateInput.value) {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);

        // 处理时区偏移
        const offset = tomorrow.getTimezoneOffset() * 60000;
        const localTomorrow = new Date(tomorrow.getTime() - offset);
        dueDateInput.value = localTomorrow.toISOString().split('T')[0];
    }
});

</script>
{% endblock %}
{% endblock %}