{% extends 'tasks/base.html' %}
{% load static %}

{% block title %}任务列表 - 任务管理工具{% endblock %}

{% block content %}
<div class="view-content" id="tasks-view">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>任务列表</h3>
        <div class="header-actions">
            <div class="input-group" style="width: 250px;">
                <input type="text" class="form-control" placeholder="搜索任务..." id="taskSearchInput" value="{{ search_query }}">
                <button class="btn btn-outline-secondary" type="button" id="taskSearchBtn">
                    <i class="bi bi-search"></i>
                </button>
            </div>
            <div class="dropdown">
                <button class="btn btn-outline-primary dropdown-toggle" type="button" id="taskFilterDropdown" data-bs-toggle="dropdown">
                    <i class="bi bi-filter"></i> 筛选
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item {% if not status_filter %}active{% endif %}" href="{% url 'tasks:task_list' %}{% if search_query %}?q={{ search_query }}{% endif %}">全部任务</a></li>
                    <li><a class="dropdown-item {% if status_filter == 'pending' %}active{% endif %}" href="{% url 'tasks:task_list' %}?status=pending{% if search_query %}&q={{ search_query }}{% endif %}">待处理</a></li>
                    <li><a class="dropdown-item {% if status_filter == 'in-progress' %}active{% endif %}" href="{% url 'tasks:task_list' %}?status=in-progress{% if search_query %}&q={{ search_query }}{% endif %}">进行中</a></li>
                    <li><a class="dropdown-item {% if status_filter == 'completed' %}active{% endif %}" href="{% url 'tasks:task_list' %}?status=completed{% if search_query %}&q={{ search_query }}{% endif %}">已完成</a></li>
                </ul>
            </div>
            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="projectFilterDropdown" data-bs-toggle="dropdown">
                    <i class="bi bi-folder"></i> 项目
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item {% if not project_filter %}active{% endif %}" href="{% url 'tasks:task_list' %}{% if status_filter %}?status={{ status_filter }}{% if search_query %}&q={{ search_query }}{% endif %}{% endif %}">全部项目</a></li>
                    {% for project in projects %}
                    <li><a class="dropdown-item {% if project_filter == project.id|stringformat:'s' %}active{% endif %}" href="{% url 'tasks:task_list' %}?project={{ project.id }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}">{{ project.name }}</a></li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-body" id="task-list-container">
            {% if tasks %}
                {% for task in tasks %}
                    {% include 'tasks/partials/task_item.html' with task=task %}
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <i class="bi bi-inbox"></i>
                    <h5>暂无任务</h5>
                    <p>点击"新建任务"按钮开始添加您的第一个任务</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 搜索功能
        const searchInput = document.getElementById('taskSearchInput');
        const searchBtn = document.getElementById('taskSearchBtn');
        
        if (searchBtn && searchInput) {
            searchBtn.addEventListener('click', function() {
                const query = searchInput.value.trim();
                let url = "{% url 'tasks:task_list' %}";
                
                // 添加状态筛选
                {% if status_filter %}
                url += "?status={{ status_filter }}";
                {% if project_filter %}
                url += "&project={{ project_filter }}";
                {% endif %}
                {% elif project_filter %}
                url += "?project={{ project_filter }}";
                {% else %}
                url += "?";
                {% endif %}
                
                if (query) {
                    url += "{% if status_filter or project_filter %}&{% endif %}q=" + encodeURIComponent(query);
                }
                
                window.location.href = url;
            });
            
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchBtn.click();
                }
            });
        }
    });
</script>
{% endblock %}
{% endblock %}