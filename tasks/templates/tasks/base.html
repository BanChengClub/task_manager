<!DOCTYPE html>
{% load static %}
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}工作任务管理工具{% endblock %}</title>
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/bootstrap-icons.css' %}">
    <link rel="stylesheet" href="{% static 'css/custom.css' %}">
    {% block extra_css %}{% endblock %}
</head>
<body>
    {% if user.is_authenticated %}
    <div class="app-container">
        {% include 'tasks/partials/sidebar.html' %}

        <div class="main-content">
            {% block content %}{% endblock %}
        </div>
    </div>
    {% else %}
        {% block auth_content %}{% endblock %}
    {% endif %}

    <script src="{% static 'js/popper.min.js' %}"></script>
    <script src="{% static 'js/bootstrap.min.js' %}"></script>
    <script>
        // 侧边栏切换功能
        document.addEventListener('DOMContentLoaded', function() {
            const toggleSidebarBtn = document.getElementById('toggleSidebar');
            if (toggleSidebarBtn) {
                toggleSidebarBtn.addEventListener('click', function() {
                    const sidebar = document.querySelector('.sidebar');
                    const mainContent = document.querySelector('.main-content');

                    if (sidebar.style.width === '70px') {
                        sidebar.style.width = '260px';
                        mainContent.style.marginLeft = '260px';

                        // 显示文本
                        document.querySelectorAll('.sidebar .nav-link span, .sidebar-heading').forEach(el => {
                            el.style.display = 'inline';
                        });

                        document.querySelector('.sidebar-header h4').style.display = 'block';
                        document.querySelector('.sidebar-header .btn').style.display = 'block';

                        this.innerHTML = '<i class="bi bi-arrow-left-circle"></i>';
                    } else {
                        sidebar.style.width = '70px';
                        mainContent.style.marginLeft = '70px';

                        // 隐藏文本
                        document.querySelectorAll('.sidebar .nav-link span, .sidebar-heading').forEach(el => {
                            el.style.display = 'none';
                        });

                        document.querySelector('.sidebar-header h4').style.display = 'none';
                        document.querySelector('.sidebar-header .btn').style.display = 'none';

                        this.innerHTML = '<i class="bi bi-arrow-right-circle"></i>';
                    }
                });
            }

            // 任务项点击事件
            document.querySelectorAll('.task-item[data-url]').forEach(item => {
                item.addEventListener('click', function(e) {
                    if (!e.target.closest('.dropdown') && !e.target.closest('a')) {
                        window.location.href = this.getAttribute('data-url');
                    }
                });
            });
        });
    </script>
    {% block extra_js %}
    <script>
        // 动态加载机型选项
        function loadModels(projectId) {
            const modelSelect = document.getElementById('id_model');

            if (projectId) {
                console.log('Loading models for project:', projectId);

                // 清空现有选项
                modelSelect.innerHTML = '';

                // 添加加载中的选项
                const loadingOption = document.createElement('option');
                loadingOption.value = '';
                loadingOption.text = '加载中...';
                modelSelect.appendChild(loadingOption);

                // 发送AJAX请求获取机型
                fetch(`/project/${projectId}/models/`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Received models data:', data);

                        // 清空选项
                        modelSelect.innerHTML = '';

                        // 添加默认选项
                        const defaultOption = document.createElement('option');
                        defaultOption.value = '';
                        defaultOption.text = '选择机型';
                        modelSelect.appendChild(defaultOption);

                        // 添加机型选项
                        if (data.length > 0) {
                            data.forEach(model => {
                                const option = document.createElement('option');
                                option.value = model.id;
                                option.text = model.name;
                                modelSelect.appendChild(option);
                            });
                        } else {
                            const noModelsOption = document.createElement('option');
                            noModelsOption.value = '';
                            noModelsOption.text = '该项目暂无机型';
                            modelSelect.appendChild(noModelsOption);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        modelSelect.innerHTML = '';

                        const errorOption = document.createElement('option');
                        errorOption.value = '';
                        errorOption.text = '加载失败';
                        modelSelect.appendChild(errorOption);
                    });
            } else {
                // 清空选项
                modelSelect.innerHTML = '';

                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.text = '请先选择项目';
                modelSelect.appendChild(defaultOption);
            }
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            const projectSelect = document.getElementById('id_project');
            const modelSelect = document.getElementById('id_model');

            console.log('Page loaded, project select:', projectSelect);
            console.log('Page loaded, model select:', modelSelect);

            // 如果项目已选择，加载对应的机型
            if (projectSelect && projectSelect.value) {
                console.log('Initial project selected:', projectSelect.value);
                loadModels(projectSelect.value);
            }

            // 监听项目选择变化
            if (projectSelect) {
                projectSelect.addEventListener('change', function() {
                    console.log('Project changed:', this.value);
                    loadModels(this.value);
                });
            }
        });
    </script>
    {% endblock %}
</body>
</html>