{% extends 'tasks/base.html' %}
{% load static %}

{% block title %}日历视图 - 任务管理工具{% endblock %}

{% block content %}
<div class="view-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>日历视图</h3>
        <div class="btn-group">
            <button class="btn btn-outline-primary" id="prev-month">
                <i class="bi bi-chevron-left"></i>
            </button>
            <button class="btn btn-outline-primary" id="current-month">
                {{ first_day|date:"Y年m月" }}
            </button>
            <button class="btn btn-outline-primary" id="next-month">
                <i class="bi bi-chevron-right"></i>
            </button>
        </div>
    </div>
    
    <div class="card">
        <div class="card-body">
            <div class="calendar-container">
                <div class="row mb-3">
                    <div class="col text-center">周日</div>
                    <div class="col text-center">周一</div>
                    <div class="col text-center">周二</div>
                    <div class="col text-center">周三</div>
                    <div class="col text-center">周四</div>
                    <div class="col text-center">周五</div>
                    <div class="col text-center">周六</div>
                </div>
                
                {% for week in calendar_weeks %}
                <div class="row mb-2">
                    {% for day in week %}
                    <div class="col calendar-day {% if day.date == today %}today{% endif %} {% if day.tasks %}has-tasks{% endif %}">
                        <div class="d-flex justify-content-between">
                            <span class="{% if day.date.month != first_day.month %}text-muted{% endif %}">
                                {{ day.date.day }}
                            </span>
                            {% if day.tasks %}
                            <span class="badge bg-primary rounded-pill">{{ day.tasks|length }}</span>
                            {% endif %}
                        </div>
                        
                        {% if day.tasks %}
                        <div class="calendar-tasks mt-2">
                            {% for task in day.tasks|slice:":3" %}
                            <div class="calendar-task" data-url="{% url 'tasks:task_detail' task.id %}">
                                {{ task.title }}
                            </div>
                            {% endfor %}
                            {% if day.tasks|length > 3 %}
                            <div class="text-center">
                                <small class="text-muted">+{{ day.tasks|length|add:"-3" }} 更多</small>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 日历任务点击事件
        document.querySelectorAll('.calendar-task').forEach(task => {
            task.addEventListener('click', function() {
                window.location.href = this.getAttribute('data-url');
            });
        });
        
        // 月份导航功能
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        
        if (prevMonthBtn && nextMonthBtn) {
            // 这里需要实现月份切换逻辑
            // 由于需要服务器端处理，这里只显示提示
            prevMonthBtn.addEventListener('click', function() {
                alert('月份切换功能需要服务器端实现');
            });
            
            nextMonthBtn.addEventListener('click', function() {
                alert('月份切换功能需要服务器端实现');
            });
        }
    });
</script>

<style>
    .calendar-day {
        min-height: 120px;
        border: 1px solid #dee2e6;
        padding: 8px;
        position: relative;
        background: white;
        transition: all 0.2s;
    }
    
    .calendar-day:hover {
        background-color: #f8f9fa;
    }
    
    .calendar-day.has-tasks {
        background-color: rgba(67, 97, 238, 0.05);
    }
    
    .calendar-day.today {
        background-color: rgba(255, 193, 7, 0.1);
        border: 2px solid #ffc107;
    }
    
    .calendar-task {
        font-size: 0.8rem;
        padding: 4px 8px;
        margin-bottom: 4px;
        border-radius: 6px;
        background-color: #e8f0fe;
        cursor: pointer;
        color: #4361ee;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .calendar-task:hover {
        background-color: #d6e4ff;
    }
</style>
{% endblock %}
{% endblock %}